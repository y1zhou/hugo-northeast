{{/* Enable image to be loaded from local page dir or media library at `static/img/`. */}}

{{ $asset := (.Page.Resources.ByType "image").GetMatch (.Get "src") }}
{{ $image_src := (.Get "src") }}

{{/* Get caption. Support legacy `title` option. */}}
{{ $caption := .Get "title" | default (.Get "caption") | default "" }}

<figure
  {{ with .Get "class" }} class="{{.}}"{{ end }}
  {{ with $caption }}id="figure-{{ anchorize . }}"{{ end }}>

  {{ if .Get "link" }}
    <a href="{{ .Get "link" }}"
      target="{{.Get "target" | default "_blank" }}"
      rel="{{.Get "rel" | default "noreferrer" }}">
  {{ end -}}

  {{/* Create smaller versions if the figure is local */}}
  {{ if $asset }}
    {{ $small := $asset.Resize "640x" }}
    {{ $medium := $asset.Resize "800x" }}
    {{ $large := $asset.Resize "1200x" }}
    {{ $xlarge := $asset.Resize "1500x" }}
    {{ $image_src = $asset.RelPermalink }}
    <img src="{{$image_src}}"
    srcset='
    {{ if ge $asset.Width "640" }}
        {{with $small.RelPermalink }}{{.}} 640w,{{- end }}
    {{ end }}
    {{ if ge $asset.Width "800" }}
        {{with $medium.RelPermalink }}{{.}} 800w,{{- end }}
    {{ end }}
    {{ if ge $asset.Width "1200" }}
        {{with $large.RelPermalink }}{{.}} 1200w,{{- end }}
    {{ end }}
    {{ if ge $asset.Width "1500" }}
        {{with $xlarge.RelPermalink }}{{.}} 1500w{{- end }}
    {{ end }}'
    loading="lazy"
    alt="{{ with .Get "alt" }}{{.}}{{end}}"
    {{ with (.Get "width") }}width="{{.}}"{{end}}
    {{ with (.Get "height") }}height="{{.}}"{{end}}>
  {{ else }}
    {{/* Lazy loading for modern browsers */}}
    <img src="{{$image_src}}"
      loading="lazy"
      alt="{{ with .Get "alt" }}{{.}}{{end}}"
      {{ with (.Get "width") }}width="{{.}}"{{end}}
      {{ with (.Get "height") }}height="{{.}}"{{end}}>
  {{ end }}

  {{- if .Get "link" }}</a>{{ end }}

  {{ if $caption }}
    {{/* Localize the figure numbering (if enabled). */}}
    {{ $figure := split "Figure %d:" "%d" }}
    <figcaption
      {{ if eq (.Get "numbered") "true" }}
        data-pre="{{ index $figure 0 }}"
        data-post="{{ index $figure 1 }}"
        class="numbered"
      {{ end }}>
      {{ $caption | markdownify | emojify }}
    </figcaption>
  {{ end }}

</figure>
